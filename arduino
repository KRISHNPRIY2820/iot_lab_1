
#include <ft2_inferencing.h>
#include <edge-impulse-sdk/classifier/ei_run_classifier.h>

float features[4];

// SAFE signal callback
int get_signal_data(size_t offset, size_t length, float *out_ptr) {
    for (size_t i = 0; i < length; i++) {
        out_ptr[i] = features[offset + i];
    }
    return 0;
}

// Read CSV: temp,hum,press,gas
bool readSerialCSV() {
    if (!Serial.available()) return false;

    String line = Serial.readStringUntil('\n');
    line.trim();

    int i1 = line.indexOf(',');
    int i2 = line.indexOf(',', i1 + 1);
    int i3 = line.indexOf(',', i2 + 1);
    if (i1 < 0 || i2 < 0 || i3 < 0) return false;

    float temp = line.substring(0, i1).toFloat();
    float hum  = line.substring(i1 + 1, i2).toFloat();
    float pres = line.substring(i2 + 1, i3).toFloat();
    float gas  = line.substring(i3 + 1).toFloat();

    // ðŸ”¥ SAME SCALING AS TRAINING
    features[0] = temp / 50.0;
    features[1] = hum  / 100.0;
    features[2] = (pres - 1000.0) / 50.0;
    features[3] = gas  / 300.0;

    for (int i = 0; i < 4; i++) {
        if (isnan(features[i]) || isinf(features[i])) return false;
    }

    return true;
}

void setup() {
    Serial.begin(115200);
    delay(2000);
    Serial.println("Nano BLE Sense â€“ ML Ready");
}

void loop() {
    if (!readSerialCSV()) return;

    ei::signal_t signal;
    signal.total_length = 4;
    signal.get_data = &get_signal_data;

    ei_impulse_result_t result;
    if (run_classifier(&signal, &result, false) != EI_IMPULSE_OK) {
        Serial.println("Inference failed");
        return;
    }

    Serial.print("Prediction â†’ ");
    float max_val = 0;
    int max_idx = -1;

    for (size_t i = 0; i < EI_CLASSIFIER_LABEL_COUNT; i++) {
        if (result.classification[i].value > max_val) {
            max_val = result.classification[i].value;
            max_idx = i;
        }
    }

    if (max_idx >= 0) {
        Serial.print(result.classification[max_idx].label);
        Serial.print(" (");
        Serial.print(max_val, 3);
        Serial.print(")");
    }
    Serial.println();
}